<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="李博的博客">
    <meta name="keyword" content="striveliboo">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        【ansible】Ansible学习笔记（1） - Liboo的博客 | Liboo&#39;s Blog
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> Internet of Everything, Everywhere. </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar">
            <img src="/img/avatar.jpg">
        </div>
        <div class="name">
            <i>H2K1E~ACE</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li>
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li>
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="/archive">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li>
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ansible-简介"><span class="toc-text">ansible 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ansible-是什么？"><span class="toc-text">ansible 是什么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ansible-特点"><span class="toc-text">ansible 特点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ansible-架构图"><span class="toc-text">ansible 架构图</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ansible-任务执行"><span class="toc-text">ansible 任务执行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ansible-任务执行模式"><span class="toc-text">ansible 任务执行模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ansible-执行流程"><span class="toc-text">ansible 执行流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ansible-命令执行过程"><span class="toc-text">ansible 命令执行过程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ansible-配置详解"><span class="toc-text">ansible 配置详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ansible-安装方式"><span class="toc-text">ansible 安装方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#使用-pip（python的包管理模块）安装"><span class="toc-text">使用 pip（python的包管理模块）安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用-yum-安装"><span class="toc-text">使用 yum 安装</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ansible-程序结构"><span class="toc-text">ansible 程序结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ansible配置文件查找顺序"><span class="toc-text">ansible配置文件查找顺序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ansible配置文件"><span class="toc-text">ansible配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ansuble主机清单"><span class="toc-text">ansuble主机清单</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ansible-常用命令"><span class="toc-text">ansible 常用命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ansible-命令集"><span class="toc-text">ansible 命令集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ansible-doc-命令"><span class="toc-text">ansible-doc 命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ansible-命令详解"><span class="toc-text">ansible 命令详解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ansible-配置公私钥"><span class="toc-text">ansible 配置公私钥</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ansible-常用模块"><span class="toc-text">ansible 常用模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1）主机连通性测试"><span class="toc-text">1）主机连通性测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2）command-模块"><span class="toc-text">2）command 模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3）shell-模块"><span class="toc-text">3）shell 模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4）copy-模块"><span class="toc-text">4）copy 模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5）file-模块"><span class="toc-text">5）file 模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6）fetch-模块"><span class="toc-text">6）fetch 模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7）cron-模块"><span class="toc-text">7）cron 模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8）yum-模块"><span class="toc-text">8）yum 模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9）service-模块"><span class="toc-text">9）service 模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10）user-模块"><span class="toc-text">10）user 模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11）group-模块"><span class="toc-text">11）group 模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12）script-模块"><span class="toc-text">12）script 模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13）setup-模块"><span class="toc-text">13）setup 模块</span></a></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input">
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>
        <div class="index-about-mobile">
            <i> Internet of Everything, Everywhere. </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        【ansible】Ansible学习笔记（1）
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2019-03-10 20:34:28</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#ansible" title="ansible">ansible</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>

    </div>
    <div class="post-content ">
        <h2 id="ansible-简介"><a href="#ansible-简介" class="headerlink" title="ansible 简介"></a>ansible 简介</h2><h3 id="ansible-是什么？"><a href="#ansible-是什么？" class="headerlink" title="ansible 是什么？"></a>ansible 是什么？</h3><p>　　ansible是新出现的自动化运维工具，基于Python开发，集合了众多运维工具（puppet、chef、func、fabric）的优点，实现了批量系统配置、批量程序部署、批量运行命令等功能。<br>　　ansible是基于 paramiko 开发的,并且基于模块化工作，本身没有批量部署的能力。真正具有批量部署的是ansible所运行的模块，ansible只是提供一种框架。ansible不需要在远程主机上安装client/agents，因为它们是基于ssh来和远<br>程主机通讯的。ansible目前已经已经被红帽官方收购，是自动化运维工具中大家认可度最高的，并且上手容易，学习简单。是每位运维工程师必须掌握的技能之一。</p>
<h3 id="ansible-特点"><a href="#ansible-特点" class="headerlink" title="ansible 特点"></a>ansible 特点</h3><ol>
<li>部署简单，只需在主控端部署Ansible环境，被控端无需做任何操作；</li>
<li>默认使用SSH协议对设备进行管理；</li>
<li>有大量常规运维操作模块，可实现日常绝大部分操作；</li>
<li>配置简单、功能强大、扩展性强；</li>
<li>支持API及自定义模块，可通过Python轻松扩展；</li>
<li>通过Playbooks来定制强大的配置、状态管理；</li>
<li>轻量级，无需在客户端安装agent，更新时，只需在操作机上进行一次更新即可；</li>
<li>提供一个功能强大、操作性强的Web管理界面和REST API接口——AWX平台。</li>
</ol>
<h3 id="ansible-架构图"><a href="#ansible-架构图" class="headerlink" title="ansible 架构图"></a>ansible 架构图</h3><p><img src="https://images2017.cnblogs.com/blog/1204916/201712/1204916-20171205163000628-69838828.png" alt="img"><br>　　上图中我们看到的主要模块如下：</p>
<blockquote>
<p><code>Ansible</code>：Ansible核心程序。<br><code>HostInventory</code>：记录由Ansible管理的主机信息，包括端口、密码、ip等。<br><code>Playbooks</code>：“剧本”YAML格式文件，多个任务定义在一个文件中，定义主机需要调用哪些模块来完成的功能。<br><code>CoreModules</code>：<strong>核心模块</strong>，主要操作是通过调用核心模块来完成管理任务。<br><code>CustomModules</code>：自定义模块，完成核心模块无法完成的功能，支持多种语言。<br><code>ConnectionPlugins</code>：连接插件，Ansible和Host通信使用</p>
</blockquote>
<h2 id="ansible-任务执行"><a href="#ansible-任务执行" class="headerlink" title="ansible 任务执行"></a>ansible 任务执行</h2><h3 id="ansible-任务执行模式"><a href="#ansible-任务执行模式" class="headerlink" title="ansible 任务执行模式"></a>ansible 任务执行模式</h3><p>　　Ansible 系统由控制主机对被管节点的操作方式可分为两类，即<code>adhoc</code>和<code>playbook</code>：</p>
<ul>
<li>ad-hoc模式(点对点模式)<br>　　使用单个模块，支持批量执行单条命令。ad-hoc 命令是一种可以快速输入的命令，而且不需要保存起来的命令。<strong>就相当于bash中的一句话shell。</strong></li>
<li>playbook模式(剧本模式)<br>　　是Ansible主要管理方式，也是Ansible功能强大的关键所在。<strong>playbook通过多个task集合完成一类功能</strong>，如Web服务的安装部署、数据库服务器的批量备份等。可以简单地把playbook理解为通过组合多条ad-hoc操作的配置文件。</li>
</ul>
<h3 id="ansible-执行流程"><a href="#ansible-执行流程" class="headerlink" title="ansible 执行流程"></a>ansible 执行流程</h3><p><img src="https://images2017.cnblogs.com/blog/1204916/201712/1204916-20171205162615738-1292598736.png" alt="img"><br>　　简单理解就是Ansible在运行时， 首先读取<code>ansible.cfg</code>中的配置， 根据规则获取<code>Inventory</code>中的管理主机列表， 并行的在这些主机中执行配置的任务， 最后等待执行返回的结果。</p>
<h3 id="ansible-命令执行过程"><a href="#ansible-命令执行过程" class="headerlink" title="ansible 命令执行过程"></a>ansible 命令执行过程</h3><ol>
<li>加载自己的配置文件，默认<code>/etc/ansible/ansible.cfg</code>；</li>
<li>查找对应的主机配置文件，找到要执行的主机或者组；</li>
<li>加载自己对应的模块文件，如 command；</li>
<li>通过ansible将模块或命令生成对应的临时py文件(python脚本)， 并将该文件传输至远程服务器；</li>
<li>对应执行用户的家目录的<code>.ansible/tmp/XXX/XXX.PY</code>文件；</li>
<li>给文件 +x 执行权限；</li>
<li>执行并返回结果；</li>
<li>删除临时py文件，<code>sleep 0</code>退出；</li>
</ol>
<h2 id="ansible-配置详解"><a href="#ansible-配置详解" class="headerlink" title="ansible 配置详解"></a>ansible 配置详解</h2><h3 id="ansible-安装方式"><a href="#ansible-安装方式" class="headerlink" title="ansible 安装方式"></a>ansible 安装方式</h3><p>　　ansible安装常用两种方式，<code>yum安装</code>和<code>pip程序安装</code>。下面我们来详细介绍一下这两种安装方式。</p>
<h4 id="使用-pip（python的包管理模块）安装"><a href="#使用-pip（python的包管理模块）安装" class="headerlink" title="使用 pip（python的包管理模块）安装"></a>使用 pip（python的包管理模块）安装</h4><p>　　首先，我们需要安装一个<code>python-pip</code>包，安装完成以后，则直接使用<code>pip</code>命令来安装我们的包，具体操作过程如下：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> python-pip</span><br><span class="line">pip <span class="keyword">install</span> ansible</span><br></pre></td></tr></table></figure>
<h4 id="使用-yum-安装"><a href="#使用-yum-安装" class="headerlink" title="使用 yum 安装"></a>使用 yum 安装</h4><p>　　yum 安装是我们很熟悉的安装方式了。我们需要先安装一个<code>epel-release</code>包，然后再安装我们的 ansible 即可。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> epel-<span class="keyword">release</span> -y</span><br><span class="line">yum <span class="keyword">install</span> ansible –y</span><br></pre></td></tr></table></figure>
<h3 id="ansible-程序结构"><a href="#ansible-程序结构" class="headerlink" title="ansible 程序结构"></a>ansible 程序结构</h3><p>安装目录如下(yum安装)：<br>　　配置文件目录：/etc/ansible/<br>　　执行文件目录：/usr/bin/<br>　　Lib库依赖目录：/usr/lib/pythonX.X/site-packages/ansible/<br>　　Help文档目录：/usr/share/doc/ansible-X.X.X/<br>　　Man文档目录：/usr/share/man/man1/</p>
<h3 id="ansible配置文件查找顺序"><a href="#ansible配置文件查找顺序" class="headerlink" title="ansible配置文件查找顺序"></a>ansible配置文件查找顺序</h3><p>　　ansible与我们其他的服务在这一点上有很大不同，这里的配置文件查找是从多个地方找的，顺序如下：</p>
<ol>
<li>检查环境变量<code>ANSIBLE_CONFIG</code>指向的路径文件(export ANSIBLE_CONFIG=/etc/ansible.cfg)；</li>
<li><code>~/.ansible.cfg</code>，检查当前目录下的ansible.cfg配置文件；</li>
<li><code>/etc/ansible.cfg</code>检查etc目录的配置文件。</li>
</ol>
<h3 id="ansible配置文件"><a href="#ansible配置文件" class="headerlink" title="ansible配置文件"></a>ansible配置文件</h3><p>　　ansible 的配置文件为<code>/etc/ansible/ansible.cfg</code>，ansible 有许多参数，下面我们列出一些常见的参数：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">inventory = /etc/ansible/hosts      <span class="comment">#这个参数表示资源清单inventory文件的位置</span></span><br><span class="line">library = /usr/share/ansible        <span class="comment">#指向存放Ansible模块的目录，支持多个目录方式，只要用冒号（：）隔开就可以</span></span><br><span class="line">forks = 5       <span class="comment">#并发连接数，默认为5</span></span><br><span class="line">sudo_user = root        <span class="comment">#设置默认执行命令的用户</span></span><br><span class="line">remote_port = 22        <span class="comment">#指定连接被管节点的管理端口，默认为22端口，建议修改，能够更加安全</span></span><br><span class="line">host_key_checking = False       <span class="comment">#设置是否检查SSH主机的密钥，值为True/False。关闭后第一次连接不会提示配置实例</span></span><br><span class="line">timeout = 60        <span class="comment">#设置SSH连接的超时时间，单位为秒</span></span><br><span class="line">log_path = /var/log/ansible.log     <span class="comment">#指定一个存储ansible日志的文件（默认不记录日志）</span></span><br></pre></td></tr></table></figure>
<h3 id="ansuble主机清单"><a href="#ansuble主机清单" class="headerlink" title="ansuble主机清单"></a>ansuble主机清单</h3><p>　　在配置文件中，我们提到了资源清单，这个清单就是我们的主机清单，里面保存的是一些 ansible 需要连接管理的主机列表。我们可以来看看他的定义方式：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1、 直接指明主机地址或主机名：</span><br><span class="line">    ## <span class="selector-tag">green</span><span class="selector-class">.example</span><span class="selector-class">.com</span>#</span><br><span class="line">    # <span class="selector-tag">blue</span><span class="selector-class">.example</span><span class="selector-class">.com</span>#</span><br><span class="line">    # 192<span class="selector-class">.168</span><span class="selector-class">.100</span><span class="selector-class">.1</span></span><br><span class="line">    # 192<span class="selector-class">.168</span><span class="selector-class">.100</span><span class="selector-class">.10</span></span><br><span class="line">2、 定义一个主机组<span class="selector-attr">[组名]</span>把地址或主机名加进去</span><br><span class="line">    <span class="selector-attr">[mysql_test]</span></span><br><span class="line">    192<span class="selector-class">.168</span><span class="selector-class">.253</span><span class="selector-class">.159</span></span><br><span class="line">    192<span class="selector-class">.168</span><span class="selector-class">.253</span><span class="selector-class">.160</span></span><br><span class="line">    192<span class="selector-class">.168</span><span class="selector-class">.253</span><span class="selector-class">.153</span></span><br></pre></td></tr></table></figure>
<p>　　需要注意的是，这里的组成员可以使用通配符来匹配，这样对于一些标准化的管理来说就很轻松方便了。<br>　　我们可以根据实际情况来配置我们的主机列表，具体操作如下：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# vim /etc/ansible/hosts</span><br><span class="line">    [web]</span><br><span class="line">    <span class="number">192.168</span><span class="number">.37</span><span class="number">.122</span></span><br><span class="line">    <span class="number">192.168</span><span class="number">.37</span><span class="number">.133</span></span><br></pre></td></tr></table></figure>
<h2 id="ansible-常用命令"><a href="#ansible-常用命令" class="headerlink" title="ansible 常用命令"></a>ansible 常用命令</h2><h3 id="ansible-命令集"><a href="#ansible-命令集" class="headerlink" title="ansible 命令集"></a>ansible 命令集</h3><blockquote>
<p><code>/usr/bin/ansible</code>　　Ansibe AD-Hoc 临时命令执行工具，常用于临时命令的执行<br><code>/usr/bin/ansible-doc</code> 　　Ansible 模块功能查看工具<br><code>/usr/bin/ansible-galaxy</code>　　下载/上传优秀代码或Roles模块 的官网平台，基于网络的<br><code>/usr/bin/ansible-playbook</code>　　Ansible 定制自动化的任务集编排工具<br><code>/usr/bin/ansible-pull</code>　　Ansible远程执行命令的工具，拉取配置而非推送配置（使用较少，海量机器时使用，对运维的架构能力要求较高）<br><code>/usr/bin/ansible-vault</code>　　Ansible 文件加密工具<br><code>/usr/bin/ansible-console</code>　　Ansible基于Linux Consoble界面可与用户交互的命令执行工具</p>
</blockquote>
<p>　　其中，我们比较常用的是<code>/usr/bin/ansible</code>和<code>/usr/bin/ansible-playbook</code>。</p>
<h3 id="ansible-doc-命令"><a href="#ansible-doc-命令" class="headerlink" title="ansible-doc 命令"></a>ansible-doc 命令</h3><p>　　ansible-doc 命令常用于获取模块信息及其使用帮助，一般用法如下：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible-doc -l              <span class="meta">#获取全部模块的信息</span></span><br><span class="line">ansible-doc -s MOD_NAME     <span class="meta">#获取指定模块的使用帮助</span></span><br></pre></td></tr></table></figure>
<p>　　我们也可以查看一下ansible-doc的全部用法：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]<span class="comment"># ansible-doc</span></span><br><span class="line">Usage: ansible-doc [options] [module...]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -h, --help            show this help message and <span class="keyword">exit</span>　　<span class="comment"># 显示命令参数API文档</span></span><br><span class="line">  -l, --list            List available modules　　<span class="comment">#列出可用的模块</span></span><br><span class="line">  -M MODULE_PATH, --module-path=MODULE_PATH　　<span class="comment">#指定模块的路径</span></span><br><span class="line">                        specify path(s) to module library (default=None)</span><br><span class="line">  -s, --snippet         Show playbook snippet <span class="keyword">for</span> specified module(s)　　<span class="comment">#显示playbook制定模块的用法</span></span><br><span class="line">  -v, --verbose         verbose mode (-vvv <span class="keyword">for</span> more, -vvvv to enable　　<span class="comment"># 显示ansible-doc的版本号查看模块列表：</span></span><br><span class="line">                        connection debugging)</span><br><span class="line">  --version             show program<span class="string">'s version number and exit</span></span><br></pre></td></tr></table></figure>
<p>　　我们可以来看一下，以mysql相关的为例：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible-doc -l |grep mysql</span><br><span class="line">mysql_db                           <span class="builtin-name">Add</span> <span class="keyword">or</span> <span class="builtin-name">remove</span> MySQL databases <span class="keyword">from</span> a remote<span class="built_in">..</span>.</span><br><span class="line">mysql_replication                  Manage MySQL replication                   </span><br><span class="line">mysql_user                         Adds <span class="keyword">or</span> removes a<span class="built_in"> user </span><span class="keyword">from</span> a MySQL databas<span class="built_in">..</span>.</span><br><span class="line">mysql_variables                    Manage MySQL global variables      </span><br><span class="line">[root@server ~]# ansible-doc -s mysql_user</span><br></pre></td></tr></table></figure>
<p><img src="https://images2017.cnblogs.com/blog/1204916/201712/1204916-20171205163026644-674759103.png" alt="img"></p>
<h3 id="ansible-命令详解"><a href="#ansible-命令详解" class="headerlink" title="ansible 命令详解"></a>ansible 命令详解</h3><p>　　命令的具体格式如下：</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible &lt;host-pattern&gt; <span class="string">[-f forks]</span> <span class="string">[-m module_name]</span> <span class="string">[-a args]</span></span><br></pre></td></tr></table></figure>
<p>　　也可以通过<code>ansible -h</code>来查看帮助，下面我们列出一些比较常用的选项，并解释其含义：</p>
<blockquote>
<p><code>-a MODULE_ARGS</code>　　　#模块的参数，如果执行默认COMMAND的模块，即是命令参数，如： “date”，“pwd”等等<br><code>-k</code>，<code>--ask-pass</code> #ask for SSH password。登录密码，提示输入SSH密码而不是假设基于密钥的验证<br><code>--ask-su-pass</code> #ask for su password。su切换密码<br><code>-K</code>，<code>--ask-sudo-pass</code> #ask for sudo password。提示密码使用sudo，sudo表示提权操作<br><code>--ask-vault-pass</code> #ask for vault password。假设我们设定了加密的密码，则用该选项进行访问<br><code>-B SECONDS</code> #后台运行超时时间<br><code>-C</code> #模拟运行环境并进行预运行，可以进行查错测试<br><code>-c CONNECTION</code> #连接类型使用<br><code>-f FORKS</code> #并行任务数，默认为5<br><code>-i INVENTORY</code> #指定主机清单的路径，默认为<code>/etc/ansible/hosts</code><br><code>--list-hosts</code> #查看有哪些主机组<br><code>-m MODULE_NAME</code> #执行模块的名字，默认使用 command 模块，所以如果是只执行单一命令可以不用 -m参数<br><code>-o</code> #压缩输出，尝试将所有结果在一行输出，一般针对收集工具使用<br><code>-S</code> #用 su 命令<br><code>-R SU_USER</code> #指定 su 的用户，默认为 root 用户<br><code>-s</code> #用 sudo 命令<br><code>-U SUDO_USER</code> #指定 sudo 到哪个用户，默认为 root 用户<br><code>-T TIMEOUT</code> #指定 ssh 默认超时时间，默认为10s，也可在配置文件中修改<br><code>-u REMOTE_USER</code> #远程用户，默认为 root 用户<br><code>-v</code> #查看详细信息，同时支持<code>-vvv</code>，<code>-vvvv</code>可查看更详细信息</p>
</blockquote>
<h3 id="ansible-配置公私钥"><a href="#ansible-配置公私钥" class="headerlink" title="ansible 配置公私钥"></a>ansible 配置公私钥</h3><p>　　上面我们已经提到过 ansible 是基于 ssh 协议实现的，所以其配置公私钥的方式与 ssh 协议的方式相同，具体操作步骤如下：</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#1.生成私钥</span></span><br><span class="line">[root<span class="symbol">@server</span> ~]<span class="meta"># ssh-keygen </span></span><br><span class="line"><span class="meta">#2.向主机分发私钥</span></span><br><span class="line">[root<span class="symbol">@server</span> ~]<span class="meta"># ssh-copy-id root@192.168.37.122</span></span><br><span class="line">[root<span class="symbol">@server</span> ~]<span class="meta"># ssh-copy-id root@192.168.37.133</span></span><br></pre></td></tr></table></figure>
<p>　　这样的话，就可以实现无密码登录，我们的实验过程也会顺畅很多。<br>　　注意，如果出现了一下报错：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-bash: ssh-<span class="keyword">copy</span>-<span class="built_in">id</span>: command <span class="keyword">not</span> found</span><br></pre></td></tr></table></figure>
<p>　　那么就证明我们需要安装一个包：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y <span class="keyword">install</span> openssh-clientsansible</span><br></pre></td></tr></table></figure>
<p>　　把包安装上即可。</p>
<h2 id="ansible-常用模块"><a href="#ansible-常用模块" class="headerlink" title="ansible 常用模块"></a>ansible 常用模块</h2><h3 id="1）主机连通性测试"><a href="#1）主机连通性测试" class="headerlink" title="1）主机连通性测试"></a>1）主机连通性测试</h3><p>　　我们使用<code>ansible web -m ping</code>命令来进行主机连通性测试，效果如下：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m ping</span><br><span class="line">192.168.37.122 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></span><br><span class="line">&#125;</span><br><span class="line">192.168.37.133 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　这样就说明我们的主机是连通状态的。接下来的操作才可以正常进行。</p>
<h3 id="2）command-模块"><a href="#2）command-模块" class="headerlink" title="2）command 模块"></a>2）command 模块</h3><p>　　这个模块可以直接在远程主机上执行命令，并将结果返回本主机。<br>　　举例如下：</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]<span class="comment"># ansible web -m command -a 'ss -ntl'</span></span><br><span class="line">192.168.37.122 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">LISTEN    <span class="number"> 0 </span>    <span class="number"> 128 </span>         *:111                      *:*                  </span><br><span class="line">LISTEN    <span class="number"> 0 </span>    <span class="number"> 5 </span>     192.168.122.1:53                       *:*                  </span><br><span class="line">LISTEN    <span class="number"> 0 </span>    <span class="number"> 128 </span>         *:22                       *:*                  </span><br><span class="line">LISTEN    <span class="number"> 0 </span>    <span class="number"> 128 </span>   127.0.0.1:631                      *:*                  </span><br><span class="line">LISTEN    <span class="number"> 0 </span>    <span class="number"> 128 </span>         *:23000                    *:*                  </span><br><span class="line">LISTEN    <span class="number"> 0 </span>    <span class="number"> 100 </span>   127.0.0.1:25                       *:*                  </span><br><span class="line">LISTEN    <span class="number"> 0 </span>    <span class="number"> 128 </span>        :::111                     :::*                  </span><br><span class="line">LISTEN    <span class="number"> 0 </span>    <span class="number"> 128 </span>        :::22                      :::*                  </span><br><span class="line">LISTEN    <span class="number"> 0 </span>    <span class="number"> 128 </span>       ::1:631                     :::*                  </span><br><span class="line">LISTEN    <span class="number"> 0 </span>    <span class="number"> 100 </span>       ::1:25                      :::*                  </span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">LISTEN    <span class="number"> 0 </span>    <span class="number"> 128 </span>         *:111                      *:*                  </span><br><span class="line">LISTEN    <span class="number"> 0 </span>    <span class="number"> 128 </span>         *:22                       *:*                  </span><br><span class="line">LISTEN    <span class="number"> 0 </span>    <span class="number"> 128 </span>   127.0.0.1:631                      *:*                  </span><br><span class="line">LISTEN    <span class="number"> 0 </span>    <span class="number"> 128 </span>         *:23000                    *:*                  </span><br><span class="line">LISTEN    <span class="number"> 0 </span>    <span class="number"> 100 </span>   127.0.0.1:25                       *:*                  </span><br><span class="line">LISTEN    <span class="number"> 0 </span>    <span class="number"> 128 </span>        :::111                     :::*                  </span><br><span class="line">LISTEN    <span class="number"> 0 </span>    <span class="number"> 128 </span>        :::22                      :::*                  </span><br><span class="line">LISTEN    <span class="number"> 0 </span>    <span class="number"> 128 </span>       ::1:631                     :::*                  </span><br><span class="line">LISTEN    <span class="number"> 0 </span>    <span class="number"> 100 </span>       ::1:25                      :::*</span><br></pre></td></tr></table></figure>
<p>　　命令模块接受命令名称，后面是空格分隔的列表参数。给定的命令将在所有选定的节点上执行。它不会通过shell进行处理，比如$HOME和操作如”&lt;”，”&gt;”，”|”，”;”，”&amp;” 工作（需要使用（shell）模块实现这些功能）。注意，该命令不支持<code>| 管道命令</code>。<br>　　下面来看一看该模块下常用的几个命令：</p>
<blockquote>
<p>chdir　　　　　　 # 在执行命令之前，先切换到该目录<br>executable # 切换shell来执行命令，需要使用命令的绝对路径<br>free_form 　 # 要执行的Linux指令，一般使用Ansible的-a参数代替。<br>creates 　# 一个文件名，当这个文件存在，则该命令不执行,可以<br>用来做判断<br>removes # 一个文件名，这个文件不存在，则该命令不执行</p>
</blockquote>
<p>　　下面我们来看看这些命令的执行效果：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m command -a 'chdir=/data/ ls'    #先切换到/data/ 目录，再执行“ls”命令</span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.122</span> | SUCCESS | rc=<span class="number">0</span> &gt;&gt;</span><br><span class="line">aaa.jpg</span><br><span class="line">fastdfs</span><br><span class="line">mogdata</span><br><span class="line">tmp</span><br><span class="line">web</span><br><span class="line">wKgleloeYoCAMLtZAAAWEekAtkc497.jpg</span><br><span class="line"></span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.133</span> | SUCCESS | rc=<span class="number">0</span> &gt;&gt;</span><br><span class="line">aaa.jpg</span><br><span class="line">fastdfs</span><br><span class="line">mogdata</span><br><span class="line">tmp</span><br><span class="line">web</span><br><span class="line">wKgleloeYoCAMLtZAAAWEekAtkc497.jpg</span><br><span class="line">[root@server ~]# ansible web -m command -a 'creates=/data/aaa.jpg ls'       #如果/data/aaa.jpg存在，则不执行“ls”命令</span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.122</span> | SUCCESS | rc=<span class="number">0</span> &gt;&gt;</span><br><span class="line">skipped, since /data/aaa.jpg exists</span><br><span class="line"></span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.133</span> | SUCCESS | rc=<span class="number">0</span> &gt;&gt;</span><br><span class="line">skipped, since /data/aaa.jpg exists</span><br><span class="line">[root@server ~]# ansible web -m command -a 'removes=/data/aaa.jpg cat /data/a'      #如果/data/aaa.jpg存在，则执行“cat /data/a”命令</span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.122</span> | SUCCESS | rc=<span class="number">0</span> &gt;&gt;</span><br><span class="line">hello</span><br><span class="line"></span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.133</span> | SUCCESS | rc=<span class="number">0</span> &gt;&gt;</span><br><span class="line">hello</span><br></pre></td></tr></table></figure>
<h3 id="3）shell-模块"><a href="#3）shell-模块" class="headerlink" title="3）shell 模块"></a>3）shell 模块</h3><p>　　shell模块可以在远程主机上调用shell解释器运行命令，支持shell的各种功能，例如管道等。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]<span class="comment"># ansible web -m shell -a 'cat /etc/passwd |grep "keer"'</span></span><br><span class="line"><span class="meta">192.168.37.122 | SUCCESS | rc=0 &gt;</span>&gt;</span><br><span class="line"><span class="symbol">keer:</span><span class="symbol">x:</span><span class="number">10001</span><span class="symbol">:</span><span class="number">1000</span><span class="symbol">:keer</span><span class="symbol">:/home/keer</span><span class="symbol">:/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="meta">192.168.37.133 | SUCCESS | rc=0 &gt;</span>&gt;</span><br><span class="line"><span class="symbol">keer:</span><span class="symbol">x:</span><span class="number">10001</span><span class="symbol">:</span><span class="number">10001</span><span class="symbol">:</span><span class="symbol">:/home/keer</span><span class="symbol">:/bin/sh</span></span><br></pre></td></tr></table></figure>
<p>　　只要是我们的shell命令，都可以通过这个模块在远程主机上运行，这里就不一一举例了。</p>
<h3 id="4）copy-模块"><a href="#4）copy-模块" class="headerlink" title="4）copy 模块"></a>4）copy 模块</h3><p>　　这个模块用于将文件复制到远程主机，同时支持给定内容生成文件和修改权限等。<br>　　其相关选项如下：</p>
<blockquote>
<p><code>src</code>　　　　#被复制到远程主机的本地文件。可以是绝对路径，也可以是相对路径。如果路径是一个目录，则会递归复制，用法类似于”rsync”<br><code>content</code>　　　#用于替换”src”，可以直接指定文件的值<br><code>dest</code>　　　　#必选项，将源文件复制到的远程主机的<strong>绝对路径</strong><br><code>backup</code>　　　#当文件内容发生改变后，在覆盖之前把源文件备份，备份文件包含时间信息<br><code>directory_mode</code>　　　　#递归设定目录的权限，默认为系统默认权限<br><code>force</code>　　　　#当目标主机包含该文件，但内容不同时，设为”yes”，表示强制覆盖；设为”no”，表示目标主机的目标位置不存在该文件才复制。默认为”yes”<br><code>others</code>　　　　#所有的 file 模块中的选项可以在这里使用</p>
</blockquote>
<p>用法举例如下：<br><strong>① 复制文件：</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@server</span> ~]# ansible web -m copy -a <span class="string">'src=~/hello dest=/data/hello'</span> </span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.122</span> | <span class="function"><span class="params">SUCCESS</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"checksum"</span>: <span class="string">"22596363b3de40b06f981fb85d82312e8c0ed511"</span>, </span><br><span class="line">    <span class="string">"dest"</span>: <span class="string">"/data/hello"</span>, </span><br><span class="line">    <span class="string">"gid"</span>: <span class="number">0</span>, </span><br><span class="line">    <span class="string">"group"</span>: <span class="string">"root"</span>, </span><br><span class="line">    <span class="string">"md5sum"</span>: <span class="string">"6f5902ac237024bdd0c176cb93063dc4"</span>, </span><br><span class="line">    <span class="string">"mode"</span>: <span class="string">"0644"</span>, </span><br><span class="line">    <span class="string">"owner"</span>: <span class="string">"root"</span>, </span><br><span class="line">    <span class="string">"size"</span>: <span class="number">12</span>, </span><br><span class="line">    <span class="string">"src"</span>: <span class="string">"/root/.ansible/tmp/ansible-tmp-1512437093.55-228281064292921/source"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"file"</span>, </span><br><span class="line">    <span class="string">"uid"</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.133</span> | <span class="function"><span class="params">SUCCESS</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"checksum"</span>: <span class="string">"22596363b3de40b06f981fb85d82312e8c0ed511"</span>, </span><br><span class="line">    <span class="string">"dest"</span>: <span class="string">"/data/hello"</span>, </span><br><span class="line">    <span class="string">"gid"</span>: <span class="number">0</span>, </span><br><span class="line">    <span class="string">"group"</span>: <span class="string">"root"</span>, </span><br><span class="line">    <span class="string">"md5sum"</span>: <span class="string">"6f5902ac237024bdd0c176cb93063dc4"</span>, </span><br><span class="line">    <span class="string">"mode"</span>: <span class="string">"0644"</span>, </span><br><span class="line">    <span class="string">"owner"</span>: <span class="string">"root"</span>, </span><br><span class="line">    <span class="string">"size"</span>: <span class="number">12</span>, </span><br><span class="line">    <span class="string">"src"</span>: <span class="string">"/root/.ansible/tmp/ansible-tmp-1512437093.74-44694985235189/source"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"file"</span>, </span><br><span class="line">    <span class="string">"uid"</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>② 给定内容生成文件，并制定权限</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@server</span> ~]# ansible web -m copy -a <span class="string">'content="I am keer\n" dest=/data/name mode=666'</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.122</span> | <span class="function"><span class="params">SUCCESS</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"checksum"</span>: <span class="string">"0421570938940ea784f9d8598dab87f07685b968"</span>, </span><br><span class="line">    <span class="string">"dest"</span>: <span class="string">"/data/name"</span>, </span><br><span class="line">    <span class="string">"gid"</span>: <span class="number">0</span>, </span><br><span class="line">    <span class="string">"group"</span>: <span class="string">"root"</span>, </span><br><span class="line">    <span class="string">"md5sum"</span>: <span class="string">"497fa8386590a5fc89090725b07f175c"</span>, </span><br><span class="line">    <span class="string">"mode"</span>: <span class="string">"0666"</span>, </span><br><span class="line">    <span class="string">"owner"</span>: <span class="string">"root"</span>, </span><br><span class="line">    <span class="string">"size"</span>: <span class="number">10</span>, </span><br><span class="line">    <span class="string">"src"</span>: <span class="string">"/root/.ansible/tmp/ansible-tmp-1512437327.37-199512601767687/source"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"file"</span>, </span><br><span class="line">    <span class="string">"uid"</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.133</span> | <span class="function"><span class="params">SUCCESS</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"checksum"</span>: <span class="string">"0421570938940ea784f9d8598dab87f07685b968"</span>, </span><br><span class="line">    <span class="string">"dest"</span>: <span class="string">"/data/name"</span>, </span><br><span class="line">    <span class="string">"gid"</span>: <span class="number">0</span>, </span><br><span class="line">    <span class="string">"group"</span>: <span class="string">"root"</span>, </span><br><span class="line">    <span class="string">"md5sum"</span>: <span class="string">"497fa8386590a5fc89090725b07f175c"</span>, </span><br><span class="line">    <span class="string">"mode"</span>: <span class="string">"0666"</span>, </span><br><span class="line">    <span class="string">"owner"</span>: <span class="string">"root"</span>, </span><br><span class="line">    <span class="string">"size"</span>: <span class="number">10</span>, </span><br><span class="line">        <span class="string">"src"</span>: <span class="string">"/root/.ansible/tmp/ansible-tmp-1512437327.55-218104039503110/source"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"file"</span>, </span><br><span class="line">    <span class="string">"uid"</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　我们现在可以去查看一下我们生成的文件及其权限：</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]<span class="comment"># ansible web -m shell -a 'ls -l /data/'</span></span><br><span class="line">192.168.37.122 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">total 28</span><br><span class="line">-rw-rw-rw-  <span class="number"> 1 </span>root root  <span class="number"> 12 </span>Dec <span class="number"> 6 </span>09:45 name</span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">total 40</span><br><span class="line">-rw-rw-rw-<span class="number"> 1 </span>root     root      <span class="number"> 12 </span>Dec <span class="number"> 5 </span>09:45 name</span><br></pre></td></tr></table></figure>
<p>　　可以看出我们的name文件已经生成，并且权限为666。<br><strong>③ 关于覆盖</strong><br>　　我们把文件的内容修改一下，然后选择覆盖备份：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@server</span> ~]# ansible web -m copy -a <span class="string">'content="I am keerya\n" backup=yes dest=/data/name mode=666'</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.122</span> | <span class="function"><span class="params">SUCCESS</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"backup_file"</span>: <span class="string">"/data/name.4394.2017-12-06@09:46:25~"</span>, </span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"checksum"</span>: <span class="string">"064a68908ab9971ee85dbc08ea038387598e3778"</span>, </span><br><span class="line">    <span class="string">"dest"</span>: <span class="string">"/data/name"</span>, </span><br><span class="line">    <span class="string">"gid"</span>: <span class="number">0</span>, </span><br><span class="line">    <span class="string">"group"</span>: <span class="string">"root"</span>, </span><br><span class="line">    <span class="string">"md5sum"</span>: <span class="string">"8ca7c11385856155af52e560f608891c"</span>, </span><br><span class="line">    <span class="string">"mode"</span>: <span class="string">"0666"</span>, </span><br><span class="line">    <span class="string">"owner"</span>: <span class="string">"root"</span>, </span><br><span class="line">    <span class="string">"size"</span>: <span class="number">12</span>, </span><br><span class="line">    <span class="string">"src"</span>: <span class="string">"/root/.ansible/tmp/ansible-tmp-1512438383.78-228128616784888/source"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"file"</span>, </span><br><span class="line">    <span class="string">"uid"</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.133</span> | <span class="function"><span class="params">SUCCESS</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"backup_file"</span>: <span class="string">"/data/name.5962.2017-12-05@09:46:24~"</span>, </span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"checksum"</span>: <span class="string">"064a68908ab9971ee85dbc08ea038387598e3778"</span>, </span><br><span class="line">    <span class="string">"dest"</span>: <span class="string">"/data/name"</span>, </span><br><span class="line">    <span class="string">"gid"</span>: <span class="number">0</span>, </span><br><span class="line">    <span class="string">"group"</span>: <span class="string">"root"</span>, </span><br><span class="line">    <span class="string">"md5sum"</span>: <span class="string">"8ca7c11385856155af52e560f608891c"</span>, </span><br><span class="line">    <span class="string">"mode"</span>: <span class="string">"0666"</span>, </span><br><span class="line">    <span class="string">"owner"</span>: <span class="string">"root"</span>, </span><br><span class="line">    <span class="string">"size"</span>: <span class="number">12</span>, </span><br><span class="line">    <span class="string">"src"</span>: <span class="string">"/root/.ansible/tmp/ansible-tmp-1512438384.0-170718946740009/source"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"file"</span>, </span><br><span class="line">    <span class="string">"uid"</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　现在我们可以去查看一下：</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]<span class="comment"># ansible web -m shell -a 'ls -l /data/'</span></span><br><span class="line">192.168.37.122 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">total 28</span><br><span class="line">-rw-rw-rw-  <span class="number"> 1 </span>root root  <span class="number"> 12 </span>Dec <span class="number"> 6 </span>09:46 name</span><br><span class="line">-rw-rw-rw-  <span class="number"> 1 </span>root root  <span class="number"> 10 </span>Dec <span class="number"> 6 </span>09:45 name.4394.2017-12-06@09:46:25~</span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">total 40</span><br><span class="line">-rw-rw-rw-<span class="number"> 1 </span>root     root      <span class="number"> 12 </span>Dec <span class="number"> 5 </span>09:46 name</span><br><span class="line">-rw-rw-rw-<span class="number"> 1 </span>root     root      <span class="number"> 10 </span>Dec <span class="number"> 5 </span>09:45 name.5962.2017-12-05@09:46:24~</span><br></pre></td></tr></table></figure>
<p>　　可以看出，我们的源文件已经被备份，我们还可以查看一下<code>name</code>文件的内容：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m shell -a 'cat /data/name'</span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.122</span> | SUCCESS | rc=<span class="number">0</span> &gt;&gt;</span><br><span class="line">I am keerya</span><br><span class="line"></span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.133</span> | SUCCESS | rc=<span class="number">0</span> &gt;&gt;</span><br><span class="line">I am keerya</span><br></pre></td></tr></table></figure>
<p>　　证明，这正是我们新导入的文件的内容。</p>
<h3 id="5）file-模块"><a href="#5）file-模块" class="headerlink" title="5）file 模块"></a>5）file 模块</h3><p>　　该模块主要用于设置文件的属性，比如创建文件、创建链接文件、删除文件等。<br>　　下面是一些常见的命令：</p>
<blockquote>
<p><code>force</code>　　#需要在两种情况下强制创建软链接，一种是源文件不存在，但之后会建立的情况下；另一种是目标软链接已存在，需要先取消之前的软链，然后创建新的软链，有两个选项：yes|no<br><code>group</code>　　#定义文件/目录的属组。后面可以加上<code>mode</code>：定义文件/目录的权限<br><code>owner</code>　　#定义文件/目录的属主。后面必须跟上<code>path</code>：定义文件/目录的路径<br><code>recurse</code>　　#递归设置文件的属性，只对目录有效，后面跟上<code>src</code>：被链接的源文件路径，只应用于<code>state=link</code>的情况<br><code>dest</code>　　#被链接到的路径，只应用于<code>state=link</code>的情况<br><code>state</code>　　#状态，有以下选项：</p>
<blockquote>
<p><code>directory</code>：如果目录不存在，就创建目录<br><code>file</code>：即使文件不存在，也不会被创建<br><code>link</code>：创建软链接<br><code>hard</code>：创建硬链接<br><code>touch</code>：如果文件不存在，则会创建一个新的文件，如果文件或目录已存在，则更新其最后修改时间<br><code>absent</code>：删除目录、文件或者取消链接文件</p>
</blockquote>
</blockquote>
<p>　　用法举例如下：<br><strong>① 创建目录：</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@server</span> ~]# ansible web -m file -a <span class="string">'path=/data/app state=directory'</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.122</span> | <span class="function"><span class="params">SUCCESS</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"gid"</span>: <span class="number">0</span>, </span><br><span class="line">    <span class="string">"group"</span>: <span class="string">"root"</span>, </span><br><span class="line">    <span class="string">"mode"</span>: <span class="string">"0755"</span>, </span><br><span class="line">    <span class="string">"owner"</span>: <span class="string">"root"</span>, </span><br><span class="line">    <span class="string">"path"</span>: <span class="string">"/data/app"</span>, </span><br><span class="line">    <span class="string">"size"</span>: <span class="number">6</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"directory"</span>, </span><br><span class="line">    <span class="string">"uid"</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.133</span> | <span class="function"><span class="params">SUCCESS</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"gid"</span>: <span class="number">0</span>, </span><br><span class="line">    <span class="string">"group"</span>: <span class="string">"root"</span>, </span><br><span class="line">    <span class="string">"mode"</span>: <span class="string">"0755"</span>, </span><br><span class="line">    <span class="string">"owner"</span>: <span class="string">"root"</span>, </span><br><span class="line">    <span class="string">"path"</span>: <span class="string">"/data/app"</span>, </span><br><span class="line">    <span class="string">"size"</span>: <span class="number">4096</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"directory"</span>, </span><br><span class="line">    <span class="string">"uid"</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　我们可以查看一下：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -<span class="keyword">m</span> <span class="keyword">shell</span> -a '<span class="keyword">ls</span> -<span class="keyword">l</span> /data'</span><br><span class="line">192.168.37.122 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line"><span class="keyword">total</span> 28</span><br><span class="line">drwxr-xr-x   2 root root    6 <span class="keyword">Dec</span>  6 10:21 <span class="keyword">app</span></span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line"><span class="keyword">total</span> 44</span><br><span class="line">drwxr-xr-x 2 root     root     4096 <span class="keyword">Dec</span>  5 10:21 <span class="keyword">app</span></span><br></pre></td></tr></table></figure>
<p>　　可以看出，我们的目录已经创建完成。<br><strong>② 创建链接文件</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@server</span> ~]# ansible web -m file -a <span class="string">'path=/data/bbb.jpg src=aaa.jpg state=link'</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.122</span> | <span class="function"><span class="params">SUCCESS</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"dest"</span>: <span class="string">"/data/bbb.jpg"</span>, </span><br><span class="line">    <span class="string">"gid"</span>: <span class="number">0</span>, </span><br><span class="line">    <span class="string">"group"</span>: <span class="string">"root"</span>, </span><br><span class="line">    <span class="string">"mode"</span>: <span class="string">"0777"</span>, </span><br><span class="line">    <span class="string">"owner"</span>: <span class="string">"root"</span>, </span><br><span class="line">    <span class="string">"size"</span>: <span class="number">7</span>, </span><br><span class="line">    <span class="string">"src"</span>: <span class="string">"aaa.jpg"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"link"</span>, </span><br><span class="line">    <span class="string">"uid"</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.133</span> | <span class="function"><span class="params">SUCCESS</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"dest"</span>: <span class="string">"/data/bbb.jpg"</span>, </span><br><span class="line">    <span class="string">"gid"</span>: <span class="number">0</span>, </span><br><span class="line">    <span class="string">"group"</span>: <span class="string">"root"</span>, </span><br><span class="line">    <span class="string">"mode"</span>: <span class="string">"0777"</span>, </span><br><span class="line">    <span class="string">"owner"</span>: <span class="string">"root"</span>, </span><br><span class="line">    <span class="string">"size"</span>: <span class="number">7</span>, </span><br><span class="line">    <span class="string">"src"</span>: <span class="string">"aaa.jpg"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"link"</span>, </span><br><span class="line">    <span class="string">"uid"</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　我们可以去查看一下：</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]<span class="comment"># ansible web -m shell -a 'ls -l /data'</span></span><br><span class="line">192.168.37.122 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">total 28</span><br><span class="line">-rw-r--r--  <span class="number"> 1 </span>root root<span class="number"> 5649 </span>Dec <span class="number"> 5 </span>13:49 aaa.jpg</span><br><span class="line">lrwxrwxrwx  <span class="number"> 1 </span>root root   <span class="number"> 7 </span>Dec <span class="number"> 6 </span>10:25 bbb.jpg -&gt; aaa.jpg</span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">total 44</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root     root    <span class="number"> 5649 </span>Dec <span class="number"> 4 </span>14:44 aaa.jpg</span><br><span class="line">lrwxrwxrwx<span class="number"> 1 </span>root     root       <span class="number"> 7 </span>Dec <span class="number"> 5 </span>10:25 bbb.jpg -&gt; aaa.jpg</span><br></pre></td></tr></table></figure>
<p>　　我们的链接文件已经创建成功。<br><strong>③ 删除文件</strong></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]<span class="comment"># ansible web -m file -a 'path=/data/a state=absent'</span></span><br><span class="line"><span class="meta">192.168.37.122 | SUCCESS =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"path"</span>: <span class="string">"/data/a"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"absent"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">192.168.37.133 | SUCCESS =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"path"</span>: <span class="string">"/data/a"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"absent"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　我们可以查看一下：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -<span class="keyword">m</span> <span class="keyword">shell</span> -<span class="keyword">a</span> <span class="string">'ls /data/a'</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">37.122</span> | FAILED | rc=<span class="number">2</span> &gt;&gt;</span><br><span class="line"><span class="keyword">l</span><span class="variable">s:</span> cannot access /data/<span class="variable">a:</span> No such <span class="keyword">file</span> <span class="built_in">or</span> directory</span><br><span class="line"></span><br><span class="line"><span class="number">192.168</span>.<span class="number">37.133</span> | FAILED | rc=<span class="number">2</span> &gt;&gt;</span><br><span class="line"><span class="keyword">l</span><span class="variable">s:</span> cannot access /data/<span class="variable">a:</span> No such <span class="keyword">file</span> <span class="built_in">or</span> directory</span><br></pre></td></tr></table></figure>
<p>　　发现已经没有这个文件了。
　　</p>
<h3 id="6）fetch-模块"><a href="#6）fetch-模块" class="headerlink" title="6）fetch 模块"></a>6）fetch 模块</h3><p>　　该模块用于从远程某主机获取（复制）文件到本地。<br>　　有两个选项：</p>
<blockquote>
<p><code>dest</code>：用来存放文件的目录<br><code>src</code>：在远程拉取的文件，并且必须是一个<strong>file</strong>，不能是<strong>目录</strong></p>
</blockquote>
<p>　　具体举例如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@server</span> ~]# ansible web -m fetch -a <span class="string">'src=/data/hello dest=/data'</span>  </span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.122</span> | <span class="function"><span class="params">SUCCESS</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"checksum"</span>: <span class="string">"22596363b3de40b06f981fb85d82312e8c0ed511"</span>, </span><br><span class="line">    <span class="string">"dest"</span>: <span class="string">"/data/192.168.37.122/data/hello"</span>, </span><br><span class="line">    <span class="string">"md5sum"</span>: <span class="string">"6f5902ac237024bdd0c176cb93063dc4"</span>, </span><br><span class="line">    <span class="string">"remote_checksum"</span>: <span class="string">"22596363b3de40b06f981fb85d82312e8c0ed511"</span>, </span><br><span class="line">    <span class="string">"remote_md5sum"</span>: <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.133</span> | <span class="function"><span class="params">SUCCESS</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"checksum"</span>: <span class="string">"22596363b3de40b06f981fb85d82312e8c0ed511"</span>, </span><br><span class="line">    <span class="string">"dest"</span>: <span class="string">"/data/192.168.37.133/data/hello"</span>, </span><br><span class="line">    <span class="string">"md5sum"</span>: <span class="string">"6f5902ac237024bdd0c176cb93063dc4"</span>, </span><br><span class="line">    <span class="string">"remote_checksum"</span>: <span class="string">"22596363b3de40b06f981fb85d82312e8c0ed511"</span>, </span><br><span class="line">    <span class="string">"remote_md5sum"</span>: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　我们可以在本机上查看一下文件是否复制成功。要注意，文件保存的路径是我们设置的接收目录下的<code>被管制主机ip</code>目录下：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# cd /data/</span><br><span class="line">[root@server data]# ls</span><br><span class="line"><span class="number">1</span>  <span class="number">192.168</span><span class="number">.37</span><span class="number">.122</span>  <span class="number">192.168</span><span class="number">.37</span><span class="number">.133</span>  fastdfs  web</span><br><span class="line">[root@server data]# cd <span class="number">192.168</span><span class="number">.37</span><span class="number">.122</span></span><br><span class="line">[root@server <span class="number">192.168</span><span class="number">.37</span><span class="number">.122</span>]# ls</span><br><span class="line">data</span><br><span class="line">[root@server <span class="number">192.168</span><span class="number">.37</span><span class="number">.122</span>]# cd data/</span><br><span class="line">[root@server data]# ls</span><br><span class="line">hello</span><br><span class="line">[root@server data]# pwd</span><br><span class="line">/data/<span class="number">192.168</span><span class="number">.37</span><span class="number">.122</span>/data</span><br></pre></td></tr></table></figure>
<h3 id="7）cron-模块"><a href="#7）cron-模块" class="headerlink" title="7）cron 模块"></a>7）cron 模块</h3><p>　　该模块适用于管理<code>cron</code>计划任务的。<br>　　其使用的语法跟我们的<code>crontab</code>文件中的语法一致，同时，可以指定以下选项：</p>
<blockquote>
<p><code>day=</code> #日应该运行的工作( 1-31, <em>,</em> /2, )<br><code>hour=</code> # 小时 ( 0-23, <em>,</em> /2, )<br><code>minute=</code> #分钟( 0-59, <em>,</em> /2, )<br><code>month=</code> # 月( 1-12, *, /2, )<br><code>weekday=</code> # 周 ( 0-6 for Sunday-Saturday,, )<br><code>job=</code> #指明运行的命令是什么<br><code>name=</code> #定时任务描述<br><code>reboot</code> # 任务在重启时运行，不建议使用，建议使用special_time<br><code>special_time</code> #特殊的时间范围，参数：reboot（重启时），annually（每年），monthly（每月），weekly（每周），daily（每天），hourly（每小时）<br><code>state</code> #指定状态，present表示添加定时任务，也是默认设置，absent表示删除定时任务<br><code>user</code> # 以哪个用户的身份执行</p>
</blockquote>
<p>　　举例如下：<br><strong>① 添加计划任务</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@server</span> ~]# ansible web -m cron -a <span class="string">'name="ntp update every 5 min" minute=*/5 job="/sbin/ntpdate 172.17.0.1 &amp;&gt; /dev/null"'</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.122</span> | <span class="function"><span class="params">SUCCESS</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"envs"</span>: [], </span><br><span class="line">    <span class="string">"jobs"</span>: [</span><br><span class="line">        <span class="string">"ntp update every 5 min"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.133</span> | <span class="function"><span class="params">SUCCESS</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"envs"</span>: [], </span><br><span class="line">    <span class="string">"jobs"</span>: [</span><br><span class="line">        <span class="string">"ntp update every 5 min"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　我们可以去查看一下：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]<span class="comment"># ansible web -m shell -a 'crontab -l'</span></span><br><span class="line">192.168.37.122 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line"><span class="comment">#Ansible: ntp update every 5 min</span></span><br><span class="line">*<span class="string">/5</span> * * * * <span class="string">/sbin/ntpdate</span> 172.17.0.1 &amp;&gt; <span class="string">/dev/null</span></span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line"><span class="comment">#Ansible: ntp update every 5 min</span></span><br><span class="line">*<span class="string">/5</span> * * * * <span class="string">/sbin/ntpdate</span> 172.17.0.1 &amp;&gt; <span class="string">/dev/null</span></span><br></pre></td></tr></table></figure>
<p>　　可以看出，我们的计划任务已经设置成功了。<br><strong>② 删除计划任务</strong><br>　　如果我们的计划任务添加错误，想要删除的话，则执行以下操作：<br>　　首先我们查看一下现有的计划任务：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]<span class="comment"># ansible web -m shell -a 'crontab -l'</span></span><br><span class="line">192.168.37.122 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line"><span class="comment">#Ansible: ntp update every 5 min</span></span><br><span class="line">*<span class="string">/5</span> * * * * <span class="string">/sbin/ntpdate</span> 172.17.0.1 &amp;&gt; <span class="string">/dev/null</span></span><br><span class="line"><span class="comment">#Ansible: df everyday</span></span><br><span class="line">* 15 * * * df -lh &gt;&gt; <span class="string">/tmp/disk_total</span> &amp;&gt; <span class="string">/dev/null</span></span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line"><span class="comment">#Ansible: ntp update every 5 min</span></span><br><span class="line">*<span class="string">/5</span> * * * * <span class="string">/sbin/ntpdate</span> 172.17.0.1 &amp;&gt; <span class="string">/dev/null</span></span><br><span class="line"><span class="comment">#Ansible: df everyday</span></span><br><span class="line">* 15 * * * df -lh &gt;&gt; <span class="string">/tmp/disk_total</span> &amp;&gt; <span class="string">/dev/null</span></span><br></pre></td></tr></table></figure>
<p>　　然后执行删除操作：</p>
<figure class="highlight sml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m cron -a <span class="symbol">'name</span>=<span class="string">"df everyday"</span> hour=<span class="number">15</span> job=<span class="string">"df -lh &gt;&gt; /tmp/disk_total &amp;&gt; /dev/null"</span> state=absent'</span><br><span class="line"><span class="number">192.168</span>.<span class="number">37.122</span> | <span class="type">SUCCESS</span> =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"envs"</span>: <span class="literal">[]</span>, </span><br><span class="line">    <span class="string">"jobs"</span>: [</span><br><span class="line">        <span class="string">"ntp update every 5 min"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">192.168</span>.<span class="number">37.133</span> | <span class="type">SUCCESS</span> =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"envs"</span>: <span class="literal">[]</span>, </span><br><span class="line">    <span class="string">"jobs"</span>: [</span><br><span class="line">        <span class="string">"ntp update every 5 min"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　删除完成后，我们再查看一下现有的计划任务确认一下：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]<span class="comment"># ansible web -m shell -a 'crontab -l'</span></span><br><span class="line">192.168.37.122 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line"><span class="comment">#Ansible: ntp update every 5 min</span></span><br><span class="line">*<span class="string">/5</span> * * * * <span class="string">/sbin/ntpdate</span> 172.17.0.1 &amp;&gt; <span class="string">/dev/null</span></span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line"><span class="comment">#Ansible: ntp update every 5 min</span></span><br><span class="line">*<span class="string">/5</span> * * * * <span class="string">/sbin/ntpdate</span> 172.17.0.1 &amp;&gt; <span class="string">/dev/null</span></span><br></pre></td></tr></table></figure>
<p>　　我们的删除操作已经成功。</p>
<h3 id="8）yum-模块"><a href="#8）yum-模块" class="headerlink" title="8）yum 模块"></a>8）yum 模块</h3><p>　　顾名思义，该模块主要用于软件的安装。<br>　　其选项如下：</p>
<blockquote>
<p><code>name=</code>　　#所安装的包的名称<br><code>state=</code>　　#<code>present</code>—&gt;安装， <code>latest</code>—&gt;安装最新的, <code>absent</code>—&gt; 卸载软件。<br><code>update_cache</code>　　#强制更新yum的缓存<br><code>conf_file</code>　　#指定远程yum安装时所依赖的配置文件（安装本地已有的包）。<br><code>disable_pgp_check</code>　　#是否禁止GPG checking，只用于<code>present</code>or <code>latest</code>。<br><code>disablerepo</code>　　#临时禁止使用yum库。 只用于安装或更新时。<br><code>enablerepo</code>　　#临时使用的yum库。只用于安装或更新时。</p>
</blockquote>
<p>　　下面我们就来安装一个包试试看：</p>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m yum -a 'name=htop state=present'</span><br><span class="line">192.168.37.122 | SUCCESS =&gt; &#123;</span><br><span class="line">    "changed": true, </span><br><span class="line">    "msg": "", </span><br><span class="line">    "rc": 0, </span><br><span class="line">    "results": [</span><br><span class="line">        "Loaded plugins: fastestmirror, langpacks<span class="symbol">\n</span>Loading mirror speeds from cached hostfile<span class="symbol">\n</span>Resolving Dependencies<span class="symbol">\n</span>--&gt; Running transaction check<span class="symbol">\n</span>---&gt; Package htop.x86_64 0:2.0.2-1.el7 will be installed<span class="symbol">\n</span>--&gt; Finished Dependency Resolution<span class="symbol">\n</span><span class="symbol">\n</span>Dependencies Resolved<span class="symbol">\n</span><span class="symbol">\n</span>================================================================================<span class="symbol">\n</span> Package         Arch              Version                Repository       Size<span class="symbol">\n</span>================================================================================<span class="symbol">\n</span>Installing:<span class="symbol">\n</span> htop            x86_64            2.0.2-1.el7            epel             98 k<span class="symbol">\n</span><span class="symbol">\n</span>Transaction Summary<span class="symbol">\n</span>================================================================================<span class="symbol">\n</span>Install  1 Package<span class="symbol">\n</span><span class="symbol">\n</span>Total download size: 98 k<span class="symbol">\n</span>Installed size: 207 k<span class="symbol">\n</span>Downloading packages:<span class="symbol">\n</span>Running transaction check<span class="symbol">\n</span>Running transaction test<span class="symbol">\n</span>Transaction test succeeded<span class="symbol">\n</span>Running transaction<span class="symbol">\n</span>  Installing : htop-2.0.2-1.el7.x86_64                                      1/1 <span class="symbol">\n</span>  Verifying  : htop-2.0.2-1.el7.x86_64                                      1/1 <span class="symbol">\n</span><span class="symbol">\n</span>Installed:<span class="symbol">\n</span>  htop.x86_64 0:2.0.2-1.el7                                                     <span class="symbol">\n</span><span class="symbol">\n</span>Complete!<span class="symbol">\n</span>"</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">192.168.37.133 | SUCCESS =&gt; &#123;</span><br><span class="line">    "changed": true, </span><br><span class="line">    "msg": "Warning: RPMDB altered outside of yum.<span class="symbol">\n</span>** Found 3 pre-existing rpmdb problem(s), 'yum check' output follows:<span class="symbol">\n</span>ipa-client-4.4.0-12.el7.centos.x86_64 has installed conflicts freeipa-client: ipa-client-4.4.0-12.el7.centos.x86_64<span class="symbol">\n</span>ipa-client-common-4.4.0-12.el7.centos.noarch has installed conflicts freeipa-client-common: ipa-client-common-4.4.0-12.el7.centos.noarch<span class="symbol">\n</span>ipa-common-4.4.0-12.el7.centos.noarch has installed conflicts freeipa-common: ipa-common-4.4.0-12.el7.centos.noarch<span class="symbol">\n</span>", </span><br><span class="line">    "rc": 0, </span><br><span class="line">    "results": [</span><br><span class="line">        "Loaded plugins: fastestmirror, langpacks<span class="symbol">\n</span>Loading mirror speeds from cached hostfile<span class="symbol">\n</span>Resolving Dependencies<span class="symbol">\n</span>--&gt; Running transaction check<span class="symbol">\n</span>---&gt; Package htop.x86_64 0:2.0.2-1.el7 will be installed<span class="symbol">\n</span>--&gt; Finished Dependency Resolution<span class="symbol">\n</span><span class="symbol">\n</span>Dependencies Resolved<span class="symbol">\n</span><span class="symbol">\n</span>================================================================================<span class="symbol">\n</span> Package         Arch              Version                Repository       Size<span class="symbol">\n</span>================================================================================<span class="symbol">\n</span>Installing:<span class="symbol">\n</span> htop            x86_64            2.0.2-1.el7            epel             98 k<span class="symbol">\n</span><span class="symbol">\n</span>Transaction Summary<span class="symbol">\n</span>================================================================================<span class="symbol">\n</span>Install  1 Package<span class="symbol">\n</span><span class="symbol">\n</span>Total download size: 98 k<span class="symbol">\n</span>Installed size: 207 k<span class="symbol">\n</span>Downloading packages:<span class="symbol">\n</span>Running transaction check<span class="symbol">\n</span>Running transaction test<span class="symbol">\n</span>Transaction test succeeded<span class="symbol">\n</span>Running transaction<span class="symbol">\n</span>  Installing : htop-2.0.2-1.el7.x86_64                                      1/1 <span class="symbol">\n</span>  Verifying  : htop-2.0.2-1.el7.x86_64                                      1/1 <span class="symbol">\n</span><span class="symbol">\n</span>Installed:<span class="symbol">\n</span>  htop.x86_64 0:2.0.2-1.el7                                                     <span class="symbol">\n</span><span class="symbol">\n</span>Complete!<span class="symbol">\n</span>"</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　安装成功。</p>
<h3 id="9）service-模块"><a href="#9）service-模块" class="headerlink" title="9）service 模块"></a>9）service 模块</h3><p>　　该模块用于服务程序的管理。<br>　　其主要选项如下：</p>
<blockquote>
<p><code>arguments</code> #命令行提供额外的参数<br><code>enabled</code> #设置开机启动。<br><code>name=</code> #服务名称<br><code>runlevel</code> #开机启动的级别，一般不用指定。<br><code>sleep</code> #在重启服务的过程中，是否等待。如在服务关闭以后等待2秒再启动。(定义在剧本中。)<br><code>state</code> #有四种状态，分别为：<code>started</code>—&gt;启动服务， <code>stopped</code>—&gt;停止服务， <code>restarted</code>—&gt;重启服务， <code>reloaded</code>—&gt;重载配置</p>
</blockquote>
<p>　　下面是一些例子：<br><strong>① 开启服务并设置自启动</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@server</span> ~]# ansible web -m service -a <span class="string">'name=nginx state=started enabled=true'</span> </span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.122</span> | <span class="function"><span class="params">SUCCESS</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"enabled"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"nginx"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"started"</span>, </span><br><span class="line">    ……</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.133</span> | <span class="function"><span class="params">SUCCESS</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"enabled"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"nginx"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"started"</span>, </span><br><span class="line">    ……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　我们可以去查看一下端口是否打开：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]<span class="comment"># ansible web -m shell -a 'ss -ntl'</span></span><br><span class="line"><span class="meta">192.168.37.122 | SUCCESS | rc=0 &gt;</span>&gt;</span><br><span class="line">State      Recv-Q Send-Q Local <span class="symbol">Address:</span>Port               Peer <span class="symbol">Address:</span>Port              </span><br><span class="line">LISTEN     <span class="number">0</span>      <span class="number">128</span>          *<span class="symbol">:</span><span class="number">80</span>                       *<span class="symbol">:*</span>                                  </span><br><span class="line"></span><br><span class="line"><span class="meta">192.168.37.133 | SUCCESS | rc=0 &gt;</span>&gt;</span><br><span class="line">State      Recv-Q Send-Q Local <span class="symbol">Address:</span>Port               Peer <span class="symbol">Address:</span>Port                    </span><br><span class="line">LISTEN     <span class="number">0</span>      <span class="number">128</span>          *<span class="symbol">:</span><span class="number">80</span>                       *<span class="symbol">:*</span></span><br></pre></td></tr></table></figure>
<p>　　可以看出我们的80端口已经打开。<br><strong>② 关闭服务</strong><br>　　我们也可以通过该模块来关闭我们的服务：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@server</span> ~]# ansible web -m service -a <span class="string">'name=nginx state=stopped'</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.122</span> | <span class="function"><span class="params">SUCCESS</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"nginx"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"stopped"</span>, </span><br><span class="line">    ……</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.133</span> | <span class="function"><span class="params">SUCCESS</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"nginx"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"stopped"</span>, </span><br><span class="line">    ……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　一样的，我们来查看一下端口：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m shell -a 'ss -ntl | grep <span class="number">80</span>'</span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.122</span> | FAILED | rc=<span class="number">1</span> &gt;&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.133</span> | FAILED | rc=<span class="number">1</span> &gt;&gt;</span><br></pre></td></tr></table></figure>
<p>　　可以看出，我们已经没有80端口了，说明我们的nginx服务已经关闭了。</p>
<h3 id="10）user-模块"><a href="#10）user-模块" class="headerlink" title="10）user 模块"></a>10）user 模块</h3><p>　　该模块主要是用来管理用户账号。<br>　　其主要选项如下：</p>
<blockquote>
<p><code>comment</code>　　# 用户的描述信息<br><code>createhome</code>　　# 是否创建家目录<br><code>force</code>　　# 在使用state=absent时, 行为与userdel –force一致.<br><code>group</code>　　# 指定基本组<br><code>groups</code>　　# 指定附加组，如果指定为(groups=)表示删除所有组<br><code>home</code>　　# 指定用户家目录<br><code>move_home</code>　　# 如果设置为home=时, 试图将用户主目录移动到指定的目录<br><code>name</code>　　# 指定用户名<br><code>non_unique</code>　　# 该选项允许改变非唯一的用户ID值<br><code>password</code>　　# 指定用户密码<br><code>remove</code>　　# 在使用state=absent时, 行为是与userdel –remove一致<br><code>shell</code>　　# 指定默认shell<br><code>state</code>　　# 设置帐号状态，不指定为创建，指定值为absent表示删除<br><code>system</code>　　# 当创建一个用户，设置这个用户是系统用户。这个设置不能更改现有用户<br><code>uid</code>　　# 指定用户的uid</p>
</blockquote>
<p>　　举例如下：<br><strong>① 添加一个用户并指定其 uid</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@server</span> ~]# ansible web -m user -a <span class="string">'name=keer uid=11111'</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.122</span> | <span class="function"><span class="params">SUCCESS</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"comment"</span>: <span class="string">""</span>, </span><br><span class="line">    <span class="string">"createhome"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"group"</span>: <span class="number">11111</span>, </span><br><span class="line">    <span class="string">"home"</span>: <span class="string">"/home/keer"</span>, </span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"keer"</span>, </span><br><span class="line">    <span class="string">"shell"</span>: <span class="string">"/bin/bash"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"present"</span>, </span><br><span class="line">    <span class="string">"stderr"</span>: <span class="string">"useradd: warning: the home directory already exists.\nNot copying any file from skel directory into it.\nCreating mailbox file: File exists\n"</span>, </span><br><span class="line">    <span class="string">"system"</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">"uid"</span>: <span class="number">11111</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.133</span> | <span class="function"><span class="params">SUCCESS</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"comment"</span>: <span class="string">""</span>, </span><br><span class="line">    <span class="string">"createhome"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"group"</span>: <span class="number">11111</span>, </span><br><span class="line">    <span class="string">"home"</span>: <span class="string">"/home/keer"</span>, </span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"keer"</span>, </span><br><span class="line">    <span class="string">"shell"</span>: <span class="string">"/bin/bash"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"present"</span>, </span><br><span class="line">    <span class="string">"stderr"</span>: <span class="string">"useradd: warning: the home directory already exists.\nNot copying any file from skel directory into it.\nCreating mailbox file: File exists\n"</span>, </span><br><span class="line">    <span class="string">"system"</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">"uid"</span>: <span class="number">11111</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　添加完成，我们可以去查看一下：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]<span class="comment"># ansible web -m shell -a 'cat /etc/passwd |grep keer'</span></span><br><span class="line"><span class="meta">192.168.37.122 | SUCCESS | rc=0 &gt;</span>&gt;</span><br><span class="line"><span class="symbol">keer:</span><span class="symbol">x:</span><span class="number">11111</span><span class="symbol">:</span><span class="number">11111</span><span class="symbol">:</span><span class="symbol">:/home/keer</span><span class="symbol">:/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="meta">192.168.37.133 | SUCCESS | rc=0 &gt;</span>&gt;</span><br><span class="line"><span class="symbol">keer:</span><span class="symbol">x:</span><span class="number">11111</span><span class="symbol">:</span><span class="number">11111</span><span class="symbol">:</span><span class="symbol">:/home/keer</span><span class="symbol">:/bin/bash</span></span><br></pre></td></tr></table></figure>
<p><strong>② 删除用户</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@server</span> ~]# ansible web -m user -a <span class="string">'name=keer state=absent'</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.122</span> | <span class="function"><span class="params">SUCCESS</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"force"</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"keer"</span>, </span><br><span class="line">    <span class="string">"remove"</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"absent"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.133</span> | <span class="function"><span class="params">SUCCESS</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"force"</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"keer"</span>, </span><br><span class="line">    <span class="string">"remove"</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"absent"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　一样的，删除之后，我们去看一下：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m shell -a 'cat /etc/passwd |grep keer'</span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.122</span> | FAILED | rc=<span class="number">1</span> &gt;&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.133</span> | FAILED | rc=<span class="number">1</span> &gt;&gt;</span><br></pre></td></tr></table></figure>
<p>　　发现已经没有这个用户了。</p>
<h3 id="11）group-模块"><a href="#11）group-模块" class="headerlink" title="11）group 模块"></a>11）group 模块</h3><p>　　该模块主要用于添加或删除组。<br>　　常用的选项如下：</p>
<blockquote>
<p><code>gid=</code>　　#设置组的GID号<br><code>name=</code>　　#指定组的名称<br><code>state=</code>　　#指定组的状态，默认为创建，设置值为<code>absent</code>为删除<br><code>system=</code>　　#设置值为<code>yes</code>，表示创建为系统组</p>
</blockquote>
<p>　　举例如下：<br><strong>① 创建组</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@server</span> ~]# ansible web -m group -a <span class="string">'name=sanguo gid=12222'</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.122</span> | <span class="function"><span class="params">SUCCESS</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"gid"</span>: <span class="number">12222</span>, </span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"sanguo"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"present"</span>, </span><br><span class="line">    <span class="string">"system"</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.133</span> | <span class="function"><span class="params">SUCCESS</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"gid"</span>: <span class="number">12222</span>, </span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"sanguo"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"present"</span>, </span><br><span class="line">    <span class="string">"system"</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　创建过后，我们来查看一下：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@server</span> ~]<span class="comment"># ansible web -m shell -a 'cat /etc/group | grep 12222' </span></span><br><span class="line">192.168.37.122 |<span class="string"> SUCCESS </span>|<span class="string"> rc=0 &gt;&gt;</span></span><br><span class="line"><span class="string">sanguo:x:12222:</span></span><br><span class="line"></span><br><span class="line"><span class="string">192.168.37.133 </span>|<span class="string"> SUCCESS </span>|<span class="string"> rc=0 &gt;&gt;</span></span><br><span class="line"><span class="string">sanguo:x:12222:</span></span><br></pre></td></tr></table></figure>
<p>　　可以看出，我们的组已经创建成功了。<br><strong>② 删除组</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@server</span> ~]# ansible web -m group -a <span class="string">'name=sanguo state=absent'</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.122</span> | <span class="function"><span class="params">SUCCESS</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"sanguo"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"absent"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.133</span> | <span class="function"><span class="params">SUCCESS</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"sanguo"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"absent"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　照例查看一下：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m shell -a 'cat /etc/group | grep <span class="number">12222</span>' </span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.122</span> | FAILED | rc=<span class="number">1</span> &gt;&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.133</span> | FAILED | rc=<span class="number">1</span> &gt;&gt;</span><br></pre></td></tr></table></figure>
<p>　　已经没有这个组的相关信息了。</p>
<h3 id="12）script-模块"><a href="#12）script-模块" class="headerlink" title="12）script 模块"></a>12）script 模块</h3><p>　　该模块用于将本机的脚本在被管理端的机器上运行。<br>　　该模块直接指定脚本的路径即可，我们通过例子来看一看到底如何使用的：<br>　　首先，我们写一个脚本，并给其加上执行权限：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]<span class="comment"># vim /tmp/df.sh</span></span><br><span class="line">    <span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">    date <span class="meta">&gt;&gt; </span>/tmp/disk_total.log</span><br><span class="line">    df -lh <span class="meta">&gt;&gt; </span>/tmp/disk_total.log </span><br><span class="line">[root@server ~]<span class="comment"># chmod +x /tmp/df.sh</span></span><br></pre></td></tr></table></figure>
<p>　　然后，我们直接运行命令来实现在被管理端执行该脚本：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@server</span> ~]# ansible web -m script -a <span class="string">'/tmp/df.sh'</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.122</span> | <span class="function"><span class="params">SUCCESS</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"rc"</span>: <span class="number">0</span>, </span><br><span class="line">    <span class="string">"stderr"</span>: <span class="string">"Shared connection to 192.168.37.122 closed.\r\n"</span>, </span><br><span class="line">    <span class="string">"stdout"</span>: <span class="string">""</span>, </span><br><span class="line">    <span class="string">"stdout_lines"</span>: []</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.133</span> | <span class="function"><span class="params">SUCCESS</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"rc"</span>: <span class="number">0</span>, </span><br><span class="line">    <span class="string">"stderr"</span>: <span class="string">"Shared connection to 192.168.37.133 closed.\r\n"</span>, </span><br><span class="line">    <span class="string">"stdout"</span>: <span class="string">""</span>, </span><br><span class="line">    <span class="string">"stdout_lines"</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　照例查看一下文件内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m shell -a &apos;cat /tmp/disk_total.log&apos;</span><br><span class="line">192.168.37.122 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">Tue Dec  5 15:58:21 CST 2017</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sda2        47G  4.4G   43G  10% /</span><br><span class="line">devtmpfs        978M     0  978M   0% /dev</span><br><span class="line">tmpfs           993M   84K  993M   1% /dev/shm</span><br><span class="line">tmpfs           993M  9.1M  984M   1% /run</span><br><span class="line">tmpfs           993M     0  993M   0% /sys/fs/cgroup</span><br><span class="line">/dev/sda3        47G   33M   47G   1% /app</span><br><span class="line">/dev/sda1       950M  153M  798M  17% /boot</span><br><span class="line">tmpfs           199M   16K  199M   1% /run/user/42</span><br><span class="line">tmpfs           199M     0  199M   0% /run/user/0</span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">Tue Dec  5 15:58:21 CST 2017</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sda2        46G  4.1G   40G  10% /</span><br><span class="line">devtmpfs        898M     0  898M   0% /dev</span><br><span class="line">tmpfs           912M   84K  912M   1% /dev/shm</span><br><span class="line">tmpfs           912M  9.0M  903M   1% /run</span><br><span class="line">tmpfs           912M     0  912M   0% /sys/fs/cgroup</span><br><span class="line">/dev/sda3       3.7G   15M  3.4G   1% /app</span><br><span class="line">/dev/sda1       1.9G  141M  1.6G   9% /boot</span><br><span class="line">tmpfs           183M   16K  183M   1% /run/user/42</span><br><span class="line">tmpfs           183M     0  183M   0% /run/user/0</span><br></pre></td></tr></table></figure>
<p>　　可以看出已经执行成功了。</p>
<h3 id="13）setup-模块"><a href="#13）setup-模块" class="headerlink" title="13）setup 模块"></a>13）setup 模块</h3><p>　　该模块主要用于收集信息，是通过调用facts组件来实现的。<br>　　facts组件是Ansible用于采集被管机器设备信息的一个功能，我们可以使用setup模块查机器的所有facts信息，可以使用filter来查看指定信息。整个facts信息被包装在一个JSON格式的数据结构中，ansible_facts是最上层的值。<br>　　facts就是变量，内建变量 。每个主机的各种信息，cpu颗数、内存大小等。会存在facts中的某个变量中。调用后返回很多对应主机的信息，在后面的操作中可以根据不同的信息来做不同的操作。如redhat系列用yum安装，而debian系列用apt来安装软件。<br><strong>① 查看信息</strong><br>　　我们可以直接用命令获取到变量的值，具体我们来看看例子：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]<span class="comment"># ansible web -m setup -a 'filter="*mem*"'   #查看内存</span></span><br><span class="line"><span class="meta">192.168.37.122 | SUCCESS =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"ansible_facts"</span>: &#123;</span><br><span class="line">        <span class="string">"ansible_memfree_mb"</span>: <span class="number">1116</span>, </span><br><span class="line">        <span class="string">"ansible_memory_mb"</span>: &#123;</span><br><span class="line">            <span class="string">"nocache"</span>: &#123;</span><br><span class="line">                <span class="string">"free"</span>: <span class="number">1397</span>, </span><br><span class="line">                <span class="string">"used"</span>: <span class="number">587</span></span><br><span class="line">            &#125;, </span><br><span class="line">            <span class="string">"real"</span>: &#123;</span><br><span class="line">                <span class="string">"free"</span>: <span class="number">1116</span>, </span><br><span class="line">                <span class="string">"total"</span>: <span class="number">1984</span>, </span><br><span class="line">                <span class="string">"used"</span>: <span class="number">868</span></span><br><span class="line">            &#125;, </span><br><span class="line">            <span class="string">"swap"</span>: &#123;</span><br><span class="line">                <span class="string">"cached"</span>: <span class="number">0</span>, </span><br><span class="line">                <span class="string">"free"</span>: <span class="number">3813</span>, </span><br><span class="line">                <span class="string">"total"</span>: <span class="number">3813</span>, </span><br><span class="line">                <span class="string">"used"</span>: <span class="number">0</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        <span class="string">"ansible_memtotal_mb"</span>: <span class="number">1984</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">192.168.37.133 | SUCCESS =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"ansible_facts"</span>: &#123;</span><br><span class="line">        <span class="string">"ansible_memfree_mb"</span>: <span class="number">1203</span>, </span><br><span class="line">        <span class="string">"ansible_memory_mb"</span>: &#123;</span><br><span class="line">            <span class="string">"nocache"</span>: &#123;</span><br><span class="line">                <span class="string">"free"</span>: <span class="number">1470</span>, </span><br><span class="line">                <span class="string">"used"</span>: <span class="number">353</span></span><br><span class="line">            &#125;, </span><br><span class="line">            <span class="string">"real"</span>: &#123;</span><br><span class="line">                <span class="string">"free"</span>: <span class="number">1203</span>, </span><br><span class="line">                <span class="string">"total"</span>: <span class="number">1823</span>, </span><br><span class="line">                <span class="string">"used"</span>: <span class="number">620</span></span><br><span class="line">            &#125;, </span><br><span class="line">            <span class="string">"swap"</span>: &#123;</span><br><span class="line">                <span class="string">"cached"</span>: <span class="number">0</span>, </span><br><span class="line">                <span class="string">"free"</span>: <span class="number">3813</span>, </span><br><span class="line">                <span class="string">"total"</span>: <span class="number">3813</span>, </span><br><span class="line">                <span class="string">"used"</span>: <span class="number">0</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        <span class="string">"ansible_memtotal_mb"</span>: <span class="number">1823</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　我们可以通过命令查看一下内存的大小以确认一下是否一致：</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]<span class="comment"># ansible web -m shell -a 'free -m'</span></span><br><span class="line">192.168.37.122 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:          <span class="number"> 1984 </span>       <span class="number"> 404 </span>      <span class="number"> 1122 </span>         <span class="number"> 9 </span>       <span class="number"> 457 </span>       1346</span><br><span class="line">Swap:         <span class="number"> 3813 </span>         <span class="number"> 0 </span>       3813</span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:          <span class="number"> 1823 </span>       <span class="number"> 292 </span>      <span class="number"> 1207 </span>         <span class="number"> 9 </span>       <span class="number"> 323 </span>       1351</span><br><span class="line">Swap:         <span class="number"> 3813 </span>         <span class="number"> 0 </span>       3813</span><br></pre></td></tr></table></figure>
<p>　　可以看出信息是一致的。<br><strong>② 保存信息</strong><br>　　我们的setup模块还有一个很好用的功能就是可以保存我们所筛选的信息至我们的主机上，同时，文件名为我们被管制的主机的IP，这样方便我们知道是哪台机器出的问题。<br>　　我们可以看一看例子：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[root@server tmp]<span class="comment"># ansible web -m setup -a 'filter="*mem*"' --tree /tmp/facts</span></span><br><span class="line"><span class="meta">192.168.37.122 | SUCCESS =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"ansible_facts"</span>: &#123;</span><br><span class="line">        <span class="string">"ansible_memfree_mb"</span>: <span class="number">1115</span>, </span><br><span class="line">        <span class="string">"ansible_memory_mb"</span>: &#123;</span><br><span class="line">            <span class="string">"nocache"</span>: &#123;</span><br><span class="line">                <span class="string">"free"</span>: <span class="number">1396</span>, </span><br><span class="line">                <span class="string">"used"</span>: <span class="number">588</span></span><br><span class="line">            &#125;, </span><br><span class="line">            <span class="string">"real"</span>: &#123;</span><br><span class="line">                <span class="string">"free"</span>: <span class="number">1115</span>, </span><br><span class="line">                <span class="string">"total"</span>: <span class="number">1984</span>, </span><br><span class="line">                <span class="string">"used"</span>: <span class="number">869</span></span><br><span class="line">            &#125;, </span><br><span class="line">            <span class="string">"swap"</span>: &#123;</span><br><span class="line">                <span class="string">"cached"</span>: <span class="number">0</span>, </span><br><span class="line">                <span class="string">"free"</span>: <span class="number">3813</span>, </span><br><span class="line">                <span class="string">"total"</span>: <span class="number">3813</span>, </span><br><span class="line">                <span class="string">"used"</span>: <span class="number">0</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        <span class="string">"ansible_memtotal_mb"</span>: <span class="number">1984</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">192.168.37.133 | SUCCESS =&gt;</span> &#123;</span><br><span class="line">    <span class="string">"ansible_facts"</span>: &#123;</span><br><span class="line">        <span class="string">"ansible_memfree_mb"</span>: <span class="number">1199</span>, </span><br><span class="line">        <span class="string">"ansible_memory_mb"</span>: &#123;</span><br><span class="line">            <span class="string">"nocache"</span>: &#123;</span><br><span class="line">                <span class="string">"free"</span>: <span class="number">1467</span>, </span><br><span class="line">                <span class="string">"used"</span>: <span class="number">356</span></span><br><span class="line">            &#125;, </span><br><span class="line">            <span class="string">"real"</span>: &#123;</span><br><span class="line">                <span class="string">"free"</span>: <span class="number">1199</span>, </span><br><span class="line">                <span class="string">"total"</span>: <span class="number">1823</span>, </span><br><span class="line">                <span class="string">"used"</span>: <span class="number">624</span></span><br><span class="line">            &#125;, </span><br><span class="line">            <span class="string">"swap"</span>: &#123;</span><br><span class="line">                <span class="string">"cached"</span>: <span class="number">0</span>, </span><br><span class="line">                <span class="string">"free"</span>: <span class="number">3813</span>, </span><br><span class="line">                <span class="string">"total"</span>: <span class="number">3813</span>, </span><br><span class="line">                <span class="string">"used"</span>: <span class="number">0</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        <span class="string">"ansible_memtotal_mb"</span>: <span class="number">1823</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　然后我们可以去查看一下：</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@server</span> ~]<span class="meta"># cd /tmp/facts/</span></span><br><span class="line">[root<span class="symbol">@server</span> facts]<span class="meta"># ls</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.37</span><span class="number">.122</span>  <span class="number">192.168</span><span class="number">.37</span><span class="number">.133</span></span><br><span class="line">[root<span class="symbol">@server</span> facts]<span class="meta"># cat 192.168.37.122 </span></span><br><span class="line">&#123;<span class="string">"ansible_facts"</span>: &#123;<span class="string">"ansible_memfree_mb"</span>: <span class="number">1115</span>, <span class="string">"ansible_memory_mb"</span>: &#123;<span class="string">"nocache"</span>: &#123;<span class="string">"free"</span>: <span class="number">1396</span>, <span class="string">"used"</span>: <span class="number">588</span>&#125;, <span class="string">"real"</span>: &#123;<span class="string">"free"</span>: <span class="number">1115</span>, <span class="string">"total"</span>: <span class="number">1984</span>, <span class="string">"used"</span>: <span class="number">869</span>&#125;, <span class="string">"swap"</span>: &#123;<span class="string">"cached"</span>: <span class="number">0</span>, <span class="string">"free"</span>: <span class="number">3813</span>, <span class="string">"total"</span>: <span class="number">3813</span>, <span class="string">"used"</span>: <span class="number">0</span>&#125;&#125;, <span class="string">"ansible_memtotal_mb"</span>: <span class="number">1984</span>&#125;, <span class="string">"changed"</span>: <span class="literal">false</span>&#125;</span><br></pre></td></tr></table></figure>
<p><em>作者：<a href="http://www.cnblogs.com/keerya/" target="_blank" rel="noopener">珂儿吖</a></em></p>
<p><em>出处：<a href="http://www.cnblogs.com/keerya/" target="_blank" rel="noopener">http://www.cnblogs.com/keerya/</a></em></p>

        
        <br>
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>
    </div>
</div>
    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        
        <li>
            <a target="_blank" href="https://www.zhihu.com/people/li-bo-2-25">
                            <span class="fa-stack fa-lg">
                                 <i class="iconfont icon-zhihu"></i>
                            </span>
            </a>
        </li>
        

        

        

        
        <li>
            <a target="_blank" href="https://github.com/liboo0731">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-github"></i>
                            </span>
            </a>
        </li>
        

        

    </ul>
    
    <p>
        <span>/</span>
        
        <span><a href="https://www.cnblogs.com/liboo/">H2K1R~ACE_博客园</a></span>
        <span>/</span>
        
        <span><a href="https://blog.csdn.net/weixin_40108079">H2K1E~ACE_CSDN</a></span>
        <span>/</span>
        
    </p>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>


    <script>
        /**
         *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
         *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
        */
        if( '' || '')
        var disqus_config = function () {
            this.page.url = '';  // Replace PAGE_URL with your page's canonical URL variable
            this.page.identifier = ''; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        };

        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');
            s.src = 'https://airclouds-blog.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>

</html>
